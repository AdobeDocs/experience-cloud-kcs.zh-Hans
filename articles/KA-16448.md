---
title: 在 AEM 实例之间迁移用户、组和 ACL
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: 0f546139887bd42346c58b8aa0ef76015688601c
workflow-type: ht
source-wordcount: '960'
ht-degree: 100%

---

# 在 AEM 实例之间迁移用户、组和 ACL

## 描述

如何在 AEM 中将具有 ACL 权限的用户和组从一台服务器迁移到另一台服务器或从一个 AEM 实例迁移到另一台服务器。

## 分辨率

**第 1 步：找到管理员和匿名用户**

1. 前往 CRXDE Lite 应用程序 `/crx/de/index.jsp` 并以管理员用户身份登录（在源系统上）。
1. 前往“工具”=“查询”。
1. 在底部的“查询”框中，输入此查询查找管理员用户：*`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. 单击“执行”并将结果中的管理员用户节点的路径复制到文本文件中。
1. 对匿名用户的查询重复步骤 3：*`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. 单击“执行”并将结果中的匿名用户节点的路径复制到一个文本文件中（所以现在您有两个路径，一个用于“管理员”，一个用于“匿名用户”）。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` – 源系统上的管理员用户

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` – 源系统上的匿名用户

**步骤 2A：迁移用户和组（使用 `crx2oak` 或者 `oak-upgrade`）**

用户和组可以使用 [crx2oak](https://helpx.adobe.com/cn/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) 或者 [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) 工具在 AEM 示例之间迁移。

1. 下载与您正在使用的 Oak 版本匹配的 `crx2oak` 或者 `oak-upgrade` jar：
   1. Oak-upgrade：[https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak：[Maven 存储库](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. 将 jar 文件上载到 AEM 服务器
1. 停止 AEM（源和目标实例）
1. 在下面的命令中替换 jar 文件的名称。
1. 用来自您的源系统的管理员和匿名用户的路径替换以下命令 *`--exclude-paths`* 部分参数中的 *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`*。
1. 在线修改路径以匹配您的实例（如果需要，在路径之前添加 *`segment-old:`*，请参见此处 [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)）：*`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. 然后在服务器的外壳上运行命令。

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. 完成后，请转到步骤 3 迁移 ACL。如果您无法使用 `crx2oak` 进行迁移，请按照下面的包迁移步骤进行操作。

**步骤 2B：迁移用户和组（使用包）**

如果用户不是通过 LDAP / SAML 身份验证或者`CRX2Oak`（上面的方法 A）自动导入的，则您可以打包用户和组。在这种情况下，您将在旧系统上创建两个单独的包（不包括管理员和匿名的开箱即用用户）。

1. 从上面第 1 步（“查找管理员和匿名用户”）的结果中复制匿名和管理员用户节点的路径。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` – 我正在创建包的系统上的管理员用户

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` – 我正在创建包的系统上的匿名用户

1. 前往“包管理器” *`http://host:port/crx/packmgr/index.jsp`*，并以管理员身份登录。
1. 创建包“用户”。
1. 使用这些排除规则（在 `/home/users` 过滤器中）将过滤器添加到 `/home/users` 的包配置中：
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. 构建包。
1. 下载包。
1. 在您的计算机上解压压缩包 zip 文件：`jar -xvf users.zip META-INF/vault/filter.xml`
1. 在文本编辑器中打开 `META-INF/vault/filter.xml` 文件。
1. 将 `mode="merge"` 添加到过滤器 ... 标记，例如：

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. 重新压缩修改后的包内容，使其包含更改。

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. 创建一个包含过滤规则 `/home/groups` 的“组”包。
1. 对组包重复步骤 11 – 14。
1. （仅限升级）如果执行迁移到较新的 AEM 版本，则安装&#x200B;*旧版本的*&#x200B;新本地 AEM 实例（没有示例内容），然后安装用户包，然后安装组包。然后，在该实例上执行就地升级到新版本。 这会将用户转换为新的 Oak 呈现。 就地升级后，再次重新打包用户以将它们移植到您的预期升级实例。 对用户组执行相同的操作。
1. 在新系统上安装用户包。
1. 在新系统上安装组包。
1. 如果您要从旧 AEM 版本迁移到 6.3，请前往 `/useradmin` UI 并将用户复制接收者添加到“管理员”组。

**步骤 3. 迁移 ACL**

如果您可以将工具 (ACS Commons) 安装到 AEM，请按照以下步骤操作：

1. 下载并安装 ACS Commons。
1. 按照此处提供的步骤创建 ACL 包。
1. 前往 http://aem-host:port/crx/packmgr/index.jsp 并以管理员身份登录。
1. 单击 ACL 包。
1.  点击编辑。
1. 选择[!UICONTROL 高级]选项卡（请参见下面的屏幕快照）。
1. 在 AC 处理下拉菜单中选择[!UICONTROL 合并]以避免移除目标系统上的现有 ACL。 在不同版本的 AEM 之间迁移 ACL 时，这一点尤其重要（因为它可以避免移除现成的 ACL）。

如果您&#x200B;*无法*&#x200B;将工具 (ACS Commons) 安装到 AEM，请按照以下步骤操作。 请注意，运行这些命令的机器必须是 Mac OS、[!DNL Linux] 或者 [!DNL Windows]（使用 [!DNL Cygwin]），带有 cURL、[!DNL Python] 和 已安装的 [!DNL Java] SDK。

1. 前往 http://src-aem-host:port/crx/packmgr/index.jsp 并以管理员身份登录。
1. 创建名为“ACL-migration”的包
1. 单击“编辑”按钮。
1. 选择[!UICONTROL 高级]选项卡并将 AC 处理模式设置为合并。
1. 进行保存。
1. 构建包并下载它。
1. 在文件系统上对包运行此命令以提取 `META-INF/vault/filter.xml` 文件：

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 在同一目录下，运行此命令从源实例下载 `/content` ACL 路径下的 json 文件（设置用户名和密码以及正确的主机）：

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. 创建文件 `generate-package-filter.py` 并在其中粘贴 [!DNL Python] 代码：

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. 运行来自创建 data.json 的同一文件夹中的 [!DNL Python] 脚本，并将输出保存到 `META-INF/vault/filter.xml`（替换 `filter.xml` 现有的内容）：

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. 使用此命令在 zip 文件中更新 `filter.xml`：

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 将 zip 文件上传到源实例包管理器：http://src-aem-host :port/crx/packmgr/index.jsp
1. 单击[!UICONTROL 构建]或者[!UICONTROL 重建]构建包。
1. 从源 AEM 服务器下载包。
1. 将包上传到目标 AEM 服务器的包管理器：http://dst-aem-host:port/crx/packmgr/index.jsp
1. 单击[!UICONTROL 安装]可安装包。
1. 对更改路径 curl 命令的任何其他路径重复步骤 8 – 16。例如，这将使位于 `/etc` 下的ACL 代替 `/content`：

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
