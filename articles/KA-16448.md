---
title: 在AEM实例之间迁移用户、组和ACL
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: af761579c3fb5e51cf5f4d144bff0e058fd13911
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 1%

---

# 在AEM实例之间迁移用户、组和ACL

## 描述

如何在AEM中将具有ACL权限的用户和组从一台服务器迁移到另一台服务器，或从一个AEM实例迁移到另一台服务器。

## 分辨率

**步骤1:查找管理员和匿名用户**

1. 转到CRXDE lite应用程序 `/crx/de/index.jsp` 并以管理员用户身份登录（在源系统上）。
1. 转到“工具”=“查询”。
1. 在底部的“查询”框中，输入此查询以查找管理员用户： *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. 单击“执行”，并将结果中管理员用户节点的路径复制到文本文件中。
1. 对匿名用户查询重复步骤3: *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. 单击“执行”，并将结果中匿名用户节点的路径复制到文本文件中（因此，现在您有两个路径，一个用于“管理员”，一个用于“匿名”）。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`  — 源系统上的管理员用户

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib`  — 源系统上的匿名用户

**步骤2A:迁移用户和组(使用 `crx2oak` 或 `oak-upgrade`)**

可以使用在AEM实例之间迁移用户和组 [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) 或 [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) 工具。

1. 下载 `crx2oak` 或 `oak-upgrade` jar与您使用的Oak版本匹配： 
   1. Oak升级： [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak: [Maven存储库](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. 将jar文件上传到AEM服务器
1. 停止AEM（源实例和目标实例）
1. 在以下命令中替换jar文件的名称。
1. 替换 *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* 在 *`--exclude-paths`* part参数，其中包含来自源系统的管理员和匿名用户的路径。
1. 在线修改路径以匹配实例(添加 *`segment-old:`* 在路径之前（如果需要），请参阅此处 [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): *`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. 然后，在服务器的Shell上运行命令。

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. 完成后，请转到步骤3以迁移ACL。  如果您无法使用 `crx2oak` 然后，请改用下面的包迁移步骤。

**步骤2B：迁移用户和组（使用包）**

如果用户未通过LDAP/SAML身份验证自动导入，或者 `CRX2Oak` （上面的方法A）然后，您可以打包用户和组。  在这种情况下，您会在旧系统上创建两个单独的资源包（不包括管理员和匿名现成用户）。

1. 从上面步骤1中的结果（“查找管理员和匿名用户”）复制匿名用户节点和管理员用户节点的路径。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`  — 在要创建资源包的系统上的管理员用户

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib`  — 我在创建包的系统上的匿名用户

1. 转到“包管理器”， *`http://host:port/crx/packmgr/index.jsp`*，并以管理员身份登录。
1. 创建资源包“用户”
1. 向包配置中添加过滤器，以便 `/home/users` 的 `/home/users` 过滤器):
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. 构建包。
1. 下载包。
1. 在您的计算机上解压缩包zip文件： `jar -xvf users.zip META-INF/vault/filter.xml`
1. 打开文件 `META-INF/vault/filter.xml` 在文本编辑器中。
1. 添加 `mode="merge"` 到过滤器……标记，例如：

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. 重新压缩修改后的包内容，以便包含更改。

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. 创建包含过滤器规则的“组”包 `/home/groups`.
1. 对组包重复步骤11-14。
1. （仅限升级）如果执行迁移到较新的AEM版本，请安装新的本地AEM实例 *旧版本*（包含nosamplecontent），然后安装用户包，然后再安装组包。 然后，在该实例上对新版本执行就地升级。 这会将用户转换为新的Oak演示文稿。 就地升级后，再次重新打包用户，以将他们端口到您预期的升级实例。 对用户组执行相同的操作。
1. 在新系统上安装用户包。
1. 在新系统上安装组包。
1. 如果您从旧版AEM迁移到6.3，请转到 `/useradmin` UI，并将用户复制接收器添加到“管理员”组。

**步骤 3. 迁移ACL**

如果您能够将工具(ACS Commons)安装到AEM，请执行以下步骤：

1. 下载并安装ACS Commons。
1. 按照此处提供的步骤创建ACL包。
1. 转到http://aem-host:port/crx/packmgr/index.jsp and ，以管理员身份登录。
1. 单击ACL包。
1.  点击编辑。
1. 选择 [!UICONTROL 高级] 选项卡（请参阅下面的屏幕截图）。
1. 在交流处理下拉菜单中，选择 [!UICONTROL 合并] 以避免删除目标系统上的现有ACL。 在AEM的不同版本之间迁移ACL时，这一点尤其重要（因为它避免了直接删除ACL）。

如果您 *not* 能够将工具(ACS Commons)安装到AEM，然后执行这些步骤。 请注意，运行这些命令的计算机必须是Mac OS， [!DNL Linux]或 [!DNL Windows] (使用 [!DNL Cygwin]), [!DNL Python]和 [!DNL Java] 已安装SDK。

1. 转到http://src-aem-host:port/crx/packmgr/index.jsp and ，以管理员身份登录。
1. 创建名为“ACL-migration”的包
1. 单击编辑按钮。
1. 选择 [!UICONTROL 高级] 选项卡，并将“AC Handling（交流处理）”模式设置为“Merge（合并）”。
1. 进行保存。
1. 构建并下载包。
1. 在文件系统上，在包中运行此命令以提取 `META-INF/vault/filter.xml` 文件： 

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 在同一目录中，运行此命令以下载ACL路径的json文件，该文件位于 `/content` 从源实例（设置用户名和密码，并更正主机）： 

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. 创建文件 `generate-package-filter.py` 并粘贴 [!DNL Python] 其下面的代码： 

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. 运行 [!DNL Python] 脚本（从创建data.json的同一文件夹中），并将输出保存到 `META-INF/vault/filter.xml` (替换 `filter.xml`): 

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. 使用此命令更新 `filter.xml` 在zip文件中：

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 将zip文件上传到源实例包管理器： http://src-aem-host:port/crx/packmgr/index.jsp
1. 单击 [!UICONTROL 生成] 或 [!UICONTROL 重建] 以构建包。
1. 从源AEM服务器下载包。
1. 将包上载到目标AEM服务器的包管理器： http://dst-aem-host:port/crx/packmgr/index.jsp
1. 单击 [!UICONTROL 安装] 来安装它。
1. 对更改路径curl命令的任何其他路径重复步骤8-16。 例如，这会获取 `/etc` 而不是 `/content`:

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
