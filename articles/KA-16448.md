---
title: 在AEM实例之间迁移用户、组和ACL
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '1132'
ht-degree: 1%

---

# 在AEM实例之间迁移用户、组和ACL

## 描述


如何在AEM中将具有ACL权限的用户和组从一台服务器迁移到另一台服务器，或从一个AEM实例迁移到另一台服务器。


## 分辨率


<b>步骤1:查找管理员和匿名用户</b>

1. 转到CRXDE lite应用程序/crx/de/index.jsp ，以管理员用户身份登录（在源系统上）。
2. 转到“工具”=“查询”。
3. 在底部的“查询”框中，输入此查询以查找管理员用户： */jcr:root/home/users//element(\*,rep:User)@rep:principalName=&quot;admin&quot;。*
4. 单击“执行”，并将结果中管理员用户节点的路径复制到文本文件中。
5. 对匿名用户查询重复步骤3: */jcr:root/home/users//element(\*,rep:User)@rep:principalName=&quot;anonymous&quot;。*
6. 单击“执行”，并将结果中匿名用户节点的路径复制到文本文件中（因此，现在您有两个路径，一个用于“管理员”，一个用于“匿名”）。



   例如：

   /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv — 源系统上的管理员用户

   /home/users/K/Kj1406Qo9IDODc_nk5Ib — 源系统上的匿名用户


<b>步骤2A:迁移用户和组（使用crx2oak或oak-upgrade）</b>

可以使用在AEM实例之间迁移用户和组 [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) 或 [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) 工具。

1. 下载与您使用的Oak版本匹配的crx2oak或oak-upgrade jar: 
   1. Oak升级： [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   2. Crx2Oak: [Maven存储库](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
2. 将jar文件上传到AEM服务器
3. 停止AEM（源实例和目标实例）
4. 在以下命令中替换jar文件的名称。
5. 替换 */home/users/Q/QY5FIMXeQIbGpwZtQ3Dv、/home/users/K/Kj1406Qo9IDODc_nk5Ib* 在 *—exclude-paths* part参数，其中包含来自源系统的管理员和匿名用户的路径。
6. 在线修改路径以匹配实例(添加 *segment-old:* 在路径之前（如果需要），请参阅此处 [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): */opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository*
7. 然后，在服务器的Shell上运行命令。     `java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \`

   `--include-paths=/home \`
   `--merge-paths=/home \`
   `--exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \`
   `segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &`
8. 完成后，请转到步骤3以迁移ACL。  如果您无法使用crx2oak进行迁移，请改为按照以下包迁移步骤进行操作。


<b>步骤2B：迁移用户和组（使用包）</b>

如果用户未通过LDAP/SAML身份验证或CRX2Oak（上述方法A）自动导入，则可以打包用户和组。  在这种情况下，您会在旧系统上创建两个单独的资源包（不包括管理员和匿名现成用户）。

1. 从上面步骤1中的结果（“查找管理员和匿名用户”）复制匿名用户节点和管理员用户节点的路径。

   例如：

   /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv — 我在其中创建包的系统上的管理员用户

   /home/users/K/Kj1406Qo9IDODc_nk5Ib — 我创建包的系统上的匿名用户
2. 转到“包管理器”， *http://host:port/crx/packmgr/index.jsp*，并以管理员身份登录。
3. 创建资源包“用户”
4. 使用以下排除规则（在/home/users筛选器上）将过滤器添加到/home/users的包配置中：
   1. 排除/home/users/。\*/.tokens
   2. 排除/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv
   3. 排除/home/users/K/Kj1406Qo9IDODc_nk5Ib
   4. exclude /home/users/a/admin
   5. exclude /home/users/a/anonymous
   6. 排除/home/users/system
   7. exclude /home/users/geometrixx
   8. 排除/home/users/media
   9. 排除/home/users/projects
   10. exclude /home/users/mac
5. 构建包。
6. 下载包。
7. 在您的计算机上解压缩包zip文件： `jar -xvf users.zip META-INF/vault/filter.xml`
8. 在文本编辑器中打开文件META-INF/vault/filter.xml 。
9. 将mode=&quot;merge&quot;添加到过滤器……标记，例如：






   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```




10. 重新压缩修改后的包内容，以便包含更改。

   `jar -uvf users.zip META-INF/vault/filter.xml`
11. 创建包含过滤器规则/home/groups的“组”包。
12. 对组包重复步骤11-14。
13. （仅限升级）如果执行迁移到较新的AEM版本，请安装新的本地AEM实例 *旧版本*（包含nosamplecontent），然后安装用户包，然后再安装组包。 然后，在该实例上对新版本执行就地升级。 这会将用户转换为新的Oak演示文稿。 就地升级后，再次重新打包用户，以将他们端口到您预期的升级实例。 对用户组执行相同的操作。
14. 在新系统上安装用户包。
15. 在新系统上安装组包。
16. 如果您从旧版AEM迁移到6.3，请转到/useradmin UI并将用户复制接收器添加到“管理员”组。




<b>步骤 3. 迁移ACL</b>

如果您能够将工具(ACS Commons)安装到AEM，请执行以下步骤：

1. 下载并安装ACS Commons。
2. 按照此处提供的步骤创建ACL包。
3. 转到http://aem-host:port/crx/packmgr/index.jsp and ，以管理员身份登录。
4. 单击ACL包。
5.  点击编辑。
6. 选择高级选项卡（请参阅下面的屏幕截图）。
7. 在交流处理下拉菜单中，选择合并以避免删除目标系统上的现有ACL。 在AEM的不同版本之间迁移ACL时，这一点尤其重要（因为它避免了直接删除ACL）。


如果您 *not* 能够将工具(ACS Commons)安装到AEM，然后执行这些步骤。 请注意，运行这些命令的计算机必须是安装了cURL、python和Java SDK的Mac OS、Linux或Windows（使用Cygwin）。

1. 转到http://src-aem-host:port/crx/packmgr/index.jsp and ，以管理员身份登录。
2. 创建名为“ACL-migration”的包
3. 单击编辑按钮。
4. 选择“高级”选项卡，并将“交流处理”模式设置为“合并”。
5. 进行保存。
6. 构建并下载包。
7. 在文件系统上，在包中运行以下命令以提取META-INF/vault/filter.xml文件： 

   `jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml`


8. 在同一目录中，运行此命令，从源实例下载/content下ACL路径的json文件（设置用户名和密码并更正主机）： 

   `curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json`


9. 创建一个文件generate-package-filter.py，并将Python代码粘贴到其下方： 

   `import` `json`


   `from pprint import` `pprint`





   `with open` `(` `'data.json') as data_file:`


   `    data = json.load(data_file)`





   `print("?xml version=\"1.0\" encoding=\"UTF-8\"?")`


   `print(` `"workspaceFilter version=\"1.0\""` `)`


   `for` `item ` `in` `data` `"results"` `:`


   `    ` `print(` `"filter root=\"{path}\" /"` `.` `format` `(path=item` `"path"` `))`


   `print(` `"/workspaceFilter"` `)`
10. 从创建data.json的同一文件夹中运行python脚本，并将输出保存到META-INF/vault/filter.xml（替换filter.xml的现有内容）： 

   `python generate-packge-filter.py  META-INF/vault/filter.xml`


11. 使用以下命令更新zip文件中的filter.xml:

   `jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml`


12. 将zip文件上传到源实例包管理器： http://src-aem-host:port/crx/packmgr/index.jsp
13. 单击生成或重新构建以生成包。
14. 从源AEM服务器下载包。
15. 将包上载到目标AEM服务器的包管理器： http://dst-aem-host:port/crx/packmgr/index.jsp
16. 单击安装以安装。
17. 对更改路径curl命令的任何其他路径重复步骤8-16。 例如，这将在/etc下获取ACL，而不是/content下获取ACL: 

   | <br><br><br>`curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   | --- |
