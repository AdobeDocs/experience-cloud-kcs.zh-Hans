---
title: 「如何最佳化Dispatcher快取？」
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS，最佳化Dispatcher快取，AEM"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Nayanika Chakravarty
article-created-date: "5/23/2023 7:20:55 PM"
article-published-by: Nayanika Chakravarty
article-published-date: "5/23/2023 8:40:51 PM"
version-number: 7
article-number: KA-17458
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=433e47ed-9ef9-ed11-8849-6045bd006b4b"
source-git-commit: 7d249351b2bbbbe47a3b0687d12862d0d0602388
workflow-type: tm+mt
source-wordcount: '1499'
ht-degree: 46%

---

# 如何最佳化Dispatcher快取？

## 描述 {#description}

<b>環境</b>
Adobe Experience Manager


<b>問題/症狀</b>
本文章著重於AEM Dispatcher中的最新最佳化以及如何將這些最佳化發揮到極致。 AEM Dispatcher是快取 [反向Proxy](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server) 專為搭配Adobe Experience Manager使用而設計的伺服器。 它可以作為現有網頁伺服器軟體中的模組來安裝和執行。 撰寫本文時， [支援Dispatcher模組](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/getting-started/dispatcher-install.html) 在Apache HTTP Server、Microsoft IIS和iPlanet上。


## 解决方法 {#resolution}


<b>Dispatcher快取如何運作？</b>

在最基本的層面上，AEM Dispatcher是一種反向Proxy，會透過執行快取、快取排清和快取失效來運作。

有关 Dispatcher 的更多详细信息，请参见相关链接：

1. [Dispatcher 如何工作以及如何安装](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/dispatcher.html).
2. [Dispatcher 中可用的配置选项](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=zh-Hans)。
3. [关于 Dispatcher 如何工作的网络研讨会](https://github.com/cqsupport/webinar-dispatchercache) – 请注意，演示文稿中的某些信息基于旧版本的 Dispatcher。
4. [关于 Dispatcher 功能、CDN 使用和安全性的 Gems 网络研讨会](https://experienceleague.adobe.com/docs/experience-manager-gems-events/gems/gems2015/aem-dispatcher-caching-new-features-and-optimizations.html)。
5. [关于 Dispatcher 中新功能的 Gems 会话（v4.1.9 之后）](https://experienceleague.adobe.com/docs/experience-manager-gems-events/gems/gems2014/aem-dispatcher.html)。


<u><b>最佳化Dispatcher快</b></u>

以下是一些最佳化Dispatcher快取的方法：

1. <b>快取幾乎所有內容</b>  — 這表示快取使用者多次請求的任何內容。
2. <b>快取不同時段的個人化內容</b>  — 如果您的網站有個人化內容，請考慮使用 [Apache Sling Dynamic Include](https://experienceleague.adobe.com/docs/experience-manager-learn/foundation/development/set-up-sling-dynamic-include.html) 在您的AEM應用程式中，利用Ajax （瀏覽器層級的非同步JavaScript和XML呼叫）、SSI （網頁伺服器層級的伺服器端包含）和ESI （CDN層級的邊緣端包含）來快取不同時段的不同頁面部分。
3. <b>永远不要删除实时 Dispatcher 上的 Dispatcher 缓存</b> – 如果 Dispatcher 正在提供实时内容并且您删除了缓存，这将导致大量请求返回 AEM。因此，绝不应该在实时 Dispatcher 上删除 Dispatcher 缓存。
4. <b>裝填快取 </b> — 刪除Dispatcher快取之前，先從負載平衡器拿掉Dispatcher，刪除快取，然後執行網頁編目程式工具以在Dispatcher上快取檔案，然後再將其放在負載平衡器上。
5. <b>快取錯誤頁面</b>  — 善用 [DispatcherPassError 1](https://helpx.adobe.com/cn/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer)<b> </b>（Apache Web Server特定）指示詞，用於從Dispatcher快取中提供錯誤頁面，例如404。
6. <b>GZip會壓縮所有檔案型別，預先壓縮的檔案除外 </b> — 在Apache Web Server， [mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) 可使用，但請確定 <b>Vary： User-Agent </b>頁首<b> </b>未設定。在 Microsoft IIS 中，使用[动态压缩](https://learn.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/)。

   Apache設定範例（僅指定特定內容型別以避免預先壓縮檔案型別）：

   <b>*AddOutputFilterByType DEFLATE文字/html文字/純文字/xml文字/css文字/javascript應用程式/javascript</b>*
7. <b>啟用 [/serveStaleOnError](https://helpx.adobe.com/cn/experience-manager/kb/ServeStaleContentOnError.html)</b> <b>在/cache設定中</b>  — 當AEM執行個體出現錯誤時提供舊快取檔案。
8. <b>新增 [/gracePeriod](https://docs.adobe.com/content/help/zh-Hans/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> <b>至/cache設定</b>  — 定義在最後一個內容發佈事件（「啟動」）之後，仍可從快取中提供過時的、自動失效的資源的秒數。这减少了在大型内容发布活动（例如“树激活”）期间返回发布实例的请求数量。
9. <b>將規則新增至 [/ignoreUrlParams](https://helpx.adobe.com/cn/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b>  — 忽略應用程式不需要或不使用的查詢字串引數。即使存在查询字符串，也允许缓存 URL。
10. <b>快取Cache-Control和Last-Modified回應標頭</b>  — 使用<b> [/headers](https://helpx.adobe.com/cn/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> 快取HTTP回應標頭的設定 <b>Cache-Control</b> 和 <b>上次修改時間 </b>(和/或 <b>ETag</b> 標頭(如果您的是從AEM傳送)。这有助于在 CDN 和浏览器级别简化和优化缓存。缓存这些标头使得只有 AEM 设置标头，而不是 Web 服务器本身。请注意，执行此操作时，您需要开始从 AEM 应用程序发送标头。
11. <b>快取內容的時間儘可能長</b> 和 <b>減少返回AEM的請求</b>  — 透過在所有排清代理程式上啟用重新擷取排清，將排清請求最佳化。 請參閱以下標題為的一節 *重新擷取Dispatcher Flush*. 或使用 [<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) 並設定 <b>Cache-Control： max-age=...</b> 標頭來儘可能長時間地快取檔案。有关此话题的详细信息，请参阅[以下内容](https://helpx.adobe.com/cn/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls)。


<u><b>使用TTL</b></u>

截至Dispatcher版本4.1.11， [/enableTTL 1](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=en#configuring-time-based-cache-invalidation-enablettl) 可在.any檔案組態中設定。  此設定使得Dispatcher採用在HTTP Cache-Control回應標頭中設定的快取有效期。换句话说，Dispatcher 的功能类似于 CDN，当文件过期时会发生主要形式的缓存失效。  實作之後開始傳送 <b>Cache-Control： max-age=... </b>對於來自AEM的所有回應，您可以在發佈執行個體中安全地停用Dispatcher Flush代理程式。

在发布实例上禁用刷新代理后，您可能仍希望能够刷新 Dispatcher 缓存。在这种情况下，您可以使用[ACS Commons – Dispatcher 刷新 UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。此工具安装在作者实例上。它为用户提供 UI，用户可以在其中执行手动缓存刷新请求。

<b>一、启用 TTL（“生存时间”或到期）样式失效的步骤：</b>

1. 修改AEM應用程式中的原始程式碼以傳送 <b>Cache-Control </b>頁首和 <b>上次修改時間 </b>適用於尚未設定的所有請求。
2. 安裝Dispatcher 4.1.11或更新版本。
3. 設定 <b>[/enableTTL 1](https://helpx.adobe.com/cn/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> 網站的.any陣列設定中。
4. 設定 <b>[/headers](https://helpx.adobe.com/cn/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>快取設定 <b>Cache-Control</b> 和 <b>上次修改時間</b> 標頭。
5. 重新启动 Web 服务器。


<b>二、在发布实例上禁用 Dispatcher 刷新代理：</b>

Dispatcher現在將使用Cache-Control標頭來控制快取檔案的失效。既然是这种情况，则不再需要从发布实例中刷新 Dispatcher 。

1. 前往每個發佈執行個體上的/etc/replication/agents.publish.html。
2. 前往每个刷新代理的配置并禁用该代理。


<b>三、允许来自作者实例的手动 Dispatcher 刷新请求：</b>

由於排清代理程式已停用，您將完全依賴 <b>Cache-Control </b>標頭來控制何時在Dispatcher上重新整理內容。您仍然可以允许用户手动刷新 Dispatcher 缓存：

1. 安装[ACS Commons – 作者实例上的 Dispatcher 刷新 UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。
2. 在作者实例上配置刷新代理。
3. 在每個代理程式設定中，設定 <b>觸發器</b> =`>`  <b>忽略預設值 </b>選項啟用。 此选项使用户在 AEM UI 中单击<b>（取消）发布</b>或者<b>（取消）激活</b>时忽略刷新代理。


<u><b>重新擷取Dispatcher Flush</b></u>

若要最佳化Dispatcher Flush請求，所有Dispatcher Flush代理程式都應該啟用稱為重新擷取排清的功能。

要启用重新获取 Dispatcher 刷新，请执行以下操作：

1. 前往 <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> 并以管理员身份登录。
2. 在[此处](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true)下载文档包。
3. 将包上传并安装到包管理器。
4. 前往 Dispatcher 刷新代理配置。 例如：<b>/etc/replication/agents.author/flush.html</b>
5. 单击<b>编辑</b>。
6. 设置以下内容
   - <b>序列化类型</b>=<b>重新获取 Dispatcher 刷新</b>
   - <b>延伸</b> =`>`  <b>HTTP方法</b> = <b>POST</b>
7. 单击<b>保存</b>


注意 — 上面安裝的套件只是一個基本範例。要自定义和优化重新获取刷新，您可以修改它发送的 URI 列表。代码是开源的，可见[此处](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle)。该代码将 URI 列表作为参数添加到请求正文中，告诉 Dispatcher 要重新获取哪些路径。您可以根据应用程序要求添加更多路径，优化站点的缓存功能。


<u><b>重新擷取排清的詳細說明</b></u>

Dispatcher Flush通常透過刪除檔案來運作：

1. 觸控式.stat檔案
2. 刪除/content/foo。\*
3. 刪除/content/foo/_jcr_content


由於在步驟2中刪除檔案，下次使用者請求/content/foo.html或/content/foo.json之類的檔案時，當「重新擷取」檔案時，隨後也將對同一檔案的請求傳送到發佈執行個體，直到已快取檔案。对于响应缓慢或流量较大的页面（例如主页），这可能会导致发布实例层泛滥。

要解决此问题，请启用 Dispatcher 的一项称为重新获取的功能。此功能允许您发送 Dispatcher 应主动“重新获取”并替换而不是删除的 URI 列表。

请参阅该[演示录音](https://my.adobeconnect.com/p7th2gf8k43)中的 22:41-27:05，获取有关它如何工作以及如何配置的演示。
