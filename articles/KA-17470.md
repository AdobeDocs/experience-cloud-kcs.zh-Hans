---
title: “错误：打开的文件过多 | AEM
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS， AEM错误，文件过多"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Victoria Barnato
article-created-date: "5/17/2023 1:46:53 AM"
article-published-by: Victoria Barnato
article-published-date: "5/17/2023 1:50:16 AM"
version-number: 7
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=286f81b1-54f4-ed11-8848-6045bd006ce9"
source-git-commit: f46170b620af53bc7afa1364d3e563b15b0fbb55
workflow-type: tm+mt
source-wordcount: '614'
ht-degree: 38%

---

# 错误：打开的文件过多 | AEM

## 描述 {#description}

<b>环境</b>
Adobe Experience Manager


<b>问题/症状</b>
日志文件包含错误“*文件过多* 和Adobe Experience Manager(AEM)未做出响应。




## 解决方法 {#resolution}


解决此问题的方法是：

1. 找出导致达到打开文件限制的原因
2. 要么增加限制，要么修复应用程序错误。


<b>A.查找哪些文件或套接字处于打开状态</b>

注意 — 打开文件限制适用于打开文件、管道和套接字的合计总数，而不仅仅适用于文件。

在Linux平台上， <b>打开文件列表</b> (`lsof`)命令可用于调试进程打开的资源。

以下是一个用于收集有用信息的示例脚本 `lsof` 输出：


```
#!/bin/bash
if `[`  $# -eq 0 `]` 
  then
    echo "No PID specified"
    echo "Run command with PID, for example:"
    echo "lsof-script.sh 12345"
    exit 2
fi
 
JAVA_PROCESS_PID=$1
 
lsof -p $JAVA_PROCESS_PID `>`  lsof-output-$JAVA_PROCESS_PID.txt
 
echo "Files open by the process:"
cat lsof-output-$JAVA_PROCESS_PID.txt |  wc -l
 
echo "Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"
cat lsof-output-$JAVA_PROCESS_PID.txt | awk '{print $9}' | sed -e "s/\(.*\)\(segmentstore\).*$/\1\2/" |  sed -e "s/\(.*\)\(repository`[` /`]` index\).*$/\1\2/" | sed -e "s/\(.*\)\(felix`[` /`]` bundle\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` lib\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` logs\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` ext\).*$/\1\2/" | sort | uniq -c | sort -rn -k1 `>`  lsof-sorted-counts-$JAVA_PROCESS_PID.txt
 
echo "Total open files in OS:"
lsof | wc -l
```


<u>示例输出</u>:


```
$`>`  ./lsof-script.sh 18070
Files open by the process:
    1995
Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt
Total open files in OS:
   18399
```


Inspect生成的 `lsof-sorted-counts-*.txt` 文件。它显示进程当前保持打开的文件或套接字。

如果您发现列出的打开套接字或文件不应该仍然打开，则可能是由于应用程序错误所致。 使用文件和套接字后，更新您的应用程序代码以关闭它们。

延迟打开套接字的常见原因是创建 Web 服务的自定义代码。在许多情况下，库（如Apache Commons） `HttpClient` 使用，但开发人员永远不会关闭连接。 请参阅 [本文](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) 有关Apache Commons的详细信息 `HttpClient`.

<b>B.提高Shell会话的限制</b>

检查用户的最大打开文件数限制，然后作为AEM进程运行时的同一用户运行以下内容：

`ulimit -Sn ulimit -Hn`

使用 AEM/CQ 的默认启动脚本时，请执行以下操作以增加限制：

1. 打开 `crx-quickstart/bin/start` 以进行编辑
2. 添加变量 `CQ_MAX_OPEN_FILES` 到脚本顶部：    `CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


如果在启动 AEM 时看到错误 `-bash: ulimit: open files: cannot modify limit: Operation not permitted`，表明以上配置未起作用。

相反，有必要增加 `/etc/security/limits.conf` 中的限制。 有关如何重新配置用户限制的详细信息，请参见下文。

如果您使用的是第三方应用程序服务器（如JBoss或Websphere），请按照以下部分操作，并使用供应商的文档进行验证。

注意：如果本文中的任何配置都无法解决问题，请使用命令查看哪些文件已打开 `lsof -p` （ — p是有问题进程的进程id）。 可能是您的应用程序使文件句柄处于打开状态。如果您发现这些句柄主要由 AEM 而不是您的应用程序持有，请联系支持人员。

<b>C.提高用户限制</b>

要更改非根用户打开文件的最大数量，请更改 `file/etc/security/limits.conf`. 您可以为每个用户设置限制：

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

注释：此配置在用户下次登录时才会生效。

<b>D.提高系统限制</b>

有时，用户限制已足够高，但系统本身已达到其最大文件数。 以su/root用户身份运行以下内容：

1. 检查操作系统上的最大打开文件设置（如果低于 20000，则增加此设置是有意义的）。    
   `cat /proc/sys/fs/file-max`
2. 将此行添加到/etc/sysctl.conf以增加系统打开文件的最大值：
   `fs.file-max = 300000`
3. 运行此命令：
   `sysctl -p`
4. 验证运行此命令时是否显示新值：    
   `cat /proc/sys/fs/file-max`


注意：此配置在用户下次登录之前不会生效。

<b>原因</b>

原因是两种可能性之一：

- 应用程序在使用文件或套接字等资源后不会关闭它们。
- 或者应用程序需要比进程允许的更多的打开文件。


<b>其他信息</b>

当系统或用户使用其最大数量的文件句柄时，会发生此错误。

您还可以执行以下操作：

1. 以管理员用户身份登录http://localhost:4502/crxde。
2. 浏览到 `/libs/granite/monitoring/config`
3. 右键单击并删除 `/libs/granite/monitoring/config`
4. 单击全部保存。 重新启动CQ。

