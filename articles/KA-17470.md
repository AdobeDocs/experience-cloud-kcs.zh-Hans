---
title: “错误：打开的文件过多”
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '732'
ht-degree: 1%

---

# 错误：打开的文件过多

## 描述

<br><br><br>问题<br><br><br><br><br><br>
日志文件包含错误“文件过多”，AEM未做出响应。
<br><br><br><br><br><br>原因<br><br><br><br><br><br>
原因有两种可能性之一：

- 使用文件或套接字等资源后，应用程序不会关闭它们。
- 或者，应用程序需要的打开文件多于流程所允许的文件。



## 分辨率

<br><br> <br><br><br><br><br><br>
解决此问题的方法是：

1. 了解导致达到打开文件限制的原因
2. 提高限制或修复应用程序错误。

<br><br><br><br>查找哪些文件或套接字处于打开状态<br><br> <br><br>
\*\*请注意，打开文件限制适用于打开文件、管道和套接字的合计总数，而不仅适用于文件。

在Linux平台上，lsof命令可用于调试进程打开的资源。

以下是用于收集有用输出列表的示例脚本：
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6<br>  7<br>  8<br>  9<br>  10<br>  11<br>  12<br>  13<br>  14<br>  15<br>  16<br>  17<br>  18<br>  19<br>  20<br>  21 | `#!/bin/bash``if` `$``# -eq 0``  ``then``    ``echo` `"No PID specified"``    ``echo` `"Run command with PID, for example:"``    ``echo` `"lsof-script.sh 12345"``    ``exit` `2``fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID``lsof``-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt | ``wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt |``awk` `'{print $9}'` `|``sed` `-e``"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(repository/index\).*$/\1\2/"` `|``sed` `-e``"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/lib\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/logs\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/ext\).*$/\1\2/"` `|``sort` `|``uniq` `-c |``sort` `-rn -k1``lsof``-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"``lsof` `|``wc` `-l` |
| --- | --- |

<br><br><br><br><br> <br><br>
示例输出：
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6 | `$ ./lsof-script.sh 18070``Files open by the process:``    ``1995``Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt``Total open files in OS:``   ``18399` |
| --- | --- |

<br><br><br><br><br> <br><br>
Inspect生成的lsof-sorted-counts-\*.txt文件的输出。  它显示进程当前打开的文件或套接字。

如果您发现列出的打开套接字或文件不应仍打开，则可能是由于应用程序错误所致。  使用文件和套接字后，更新您的应用程序代码以关闭它们。

延迟打开套接字的一个常见原因是创建Web服务的自定义代码。  在许多情况下，会使用诸如Apache Commons HttpClient之类的库，但开发人员永远不会关闭连接。  请参阅 [本文](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) 有关Apache Commons HttpClient的详细信息。
<br><br><br><br> <br><br>提高Shell会话的限制<br><br><br><br> <br><br>
检查用户的最大打开文件数限制，然后作为AEM进程运行时的同一用户运行以下内容：

ulimit -Sn ulimit -Hn

使用AEM/CQ的默认启动脚本时，请执行以下操作以提高限制：

1. 打开crx-quickstart/bin/start进行编辑
2. 将变量CQ_MAX_OPEN_FILES添加到脚本顶部：CQ_MAX_OPEN_FILES=8192导出CQ_MAX_OPEN_FILES


如果看到错误“ — bash:上限：打开文件：无法修改限制：不允许的操作”，则上述配置将不起作用。

相反，必须提高/etc/security/limits.conf中的限制。 有关如何重新配置用户限制的详细信息，请参阅下文。

如果您使用的是第三方应用程序服务器（如JBoss或Websphere），请按照以下部分操作，并使用供应商的文档进行验证。

注释：

如果本文中的任何配置都没有解决问题，请使用命令lsof -p查看哪些文件是打开的。（ — p是有问题的进程的进程id。） 可能是您的应用程序使文件句柄处于打开状态。 如果您发现句柄主要由AEM持有，而不是您的应用程序，请联系支持人员。


<br><br><br><br> <br><br>提高用户限制<br><br><br><br> <br><br>
要更改非根用户打开文件的最大数量，请更改文件/etc/security/limits.conf 。 您可以根据每个用户设置限制：

crx_process_username软nofile 8092

crx_process_username硬文件20000

注释：

此配置在用户下次登录之前不会生效。


<br><br><br><br> <br><br>提高系统限制<br><br><br><br> <br><br>
有时，用户限制已足够高，但系统本身已达到其最大文件数。 以su/root用户身份运行以下内容：

1. 检查操作系统上的最大打开文件设置(如果低于20000，则增加此设置是合理的)。    cat /proc/sys/fs/file-max
2. 将此行添加到/etc/sysctl.conf以增加系统打开文件的最大值：fs.file-max = 300000
3. 运行以下命令：sysctl -p
4. 验证在运行此命令时是否显示新值：cat /proc/sys/fs/file-max


注释：

此配置在用户下次登录之前不会生效。


<br><br><br><br> <br><br>其他信息<br><br><br><br> <br><br>
当系统或用户使用其最大数量的文件句柄时，会发生此错误。

下载
[获取文件](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>可用于监视打开文件使用情况的Shell脚本。 仅当“打开的文件过多”错误在增大最大值后仍然存在时，才使用此脚本。 或者，如果您怀疑CRX或您的应用程序保持文件句柄处于打开状态，则可以使用它。 在使用脚本之前，请配置以下变量：JAVA_HOME、QUICKSTART_PATH、OUTPUT_DIR、USER、MAX_FILES_THRESHOLD。 要使用脚本，请将其配置为cron作业。
