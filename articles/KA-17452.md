---
title: "从JVM获取线程转储"
description: 描述
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 6:41:42 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 6:48:01 PM"
version-number: 1
article-number: KA-17452
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=2e54c459-d531-ec11-b6e5-000d3a5ba97a"
exl-id: 9ad0fefe-b974-45d9-95b6-4a90f691f0cb
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1052'
ht-degree: 0%

---

# 从JVM获取线程转储

## 描述

<br><br><br>如何从上的JVM获取线程转储 [!DNL Linux]、UNIX或 [!DNL Windows]?<br><br><br><br> <br><br>
线程转储是所有 [!DNL Java] 当前在 [!DNL Java Virtual Machine] (JVM)。

从JVM获取线程转储的方法有多种。 强烈建议占用1个以上线程转储。 一个好做法是以常规间隔获取10个线程转储（例如，每10秒转储一个线程）。


## 分辨率

<br><br>步骤1:获取 [!DNL Java] 过程<br><br><br><br> <br><br>
您需要获取线程转储的第一条信息是 [!DNL Java] 进程PID。

的 [!DNL Java] JDK随jps命令一起提供，该命令列出了所有 [!DNL Java] 进程id。 您可以以如下方式运行此命令：


```
jps -l 70660 sun.tools.jps.Jps 70305
```


<b>注意：</b> 在 [!DNL Linux] 和UNIX，则可能必须以 `sudo -u user jps -l`，其中“user”是 [!DNL Java] 进程以形式运行。

如果这不起作用，或者您仍然找不到 [!DNL Java] 进程、（未设置路径、未安装JDK或更早版本） [!DNL Java] 版本)，使用

- UNIX 、 [!DNL Linux]和Mac OS X: `ps -el | grep java`
- [!DNL Windows]：按Ctrl+Shift+Esc打开任务管理器并查找 [!DNL Java] 过程

<br><br><br><br><br><br>步骤2:从JVM请求线程转储<br><br><br><br><br><br><br><br>
<b>jstack</b>

如果已安装/可用，我们建议使用 <b>jstack</b> 工具。 它会将线程转储打印到命令行控制台。

要使用jstack获取线程转储，请运行以下命令：
`jstack -l pid`

您可以使用控制台输出重定向/追加指令将连续的线程转储输出到文件：
`jstack -l pid  threaddumps.log`

注意：

- jstack工具自JDK 1.5（用于上的JVM）起便可用 [!DNL Windows]，该插件仅在某些版本的JDK 1.5和JDK 1.6中可用)。
- 即使jstack有效， `-Xrs` 启用jvm参数
- 无法使用JDK 1.6中的jstack工具从JDK 1.5上运行的进程中获取线程转储。
- 在 [!DNL Linux] 和UNIX中，您需要作为拥有java进程的用户运行该命令：

   `sudo -u *java-user* jstack -l *pid*`  

   (java-user应被 [!DNL Java] 进程运行为)
- 在 [!DNL Windows]，如果运行jstack并收到错误“存储不足，无法处理此命令”，则必须作为windows SYSTEM用户或拥有java进程的用户运行jstack。  您可以使用可下载的psexec执行此操作 [此处](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx). 要以SYSTEM用户身份运行jstack，请使用以下命令：

   `psexec -s jstack *pid*   threaddumps.log`

   如果无法在服务器上安装psexec，则可以创建包含命令的.bat文件并运行该文件 [使用 [!DNL Windows] 任务调度程序（作为其他用户）](https://technet.microsoft.com/en-us/library/cc748993%28v=ws.11%29.aspx).
- 如果java进程没有响应，则有时使用选项会有所帮助 <b>`-J-d64`</b> （在64位系统上），例如：

   `jstack -J-d64 -l *pid*  threaddumps.log`
- 如果jstack命令(`jstack -l pid  threaddumps.log`)在下面引发错误1，然后作为拥有java进程的用户运行该命令。  例如：

   `sudo -u sling jstack -l pid  threaddumps.log`



<br><br><br><br><br><br> <br><br><br><br>

```
Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

sun.jvm.hotspot.debugger.linux.LinuxDebuggerLocal$LinuxDebuggerLocalWorkerThread.run(LinuxDebuggerLocal.java:138)
```



<br><br>JSTACK脚本<br><br>
这是 [script](https://github.com/cqsupport/jstackSeries.sh/blob/master/jstackSeries.sh) （从上改编） [eclipse.org](http://wiki.eclipse.org/How_to_report_a_deadlock#jstackSeries_--_jstack_sampling_in_fixed_time_intervals_.28tested_on_Linux.29))会使用jstack获取一系列线程转储。  它还使用top命令获取线程级cpu的使用情况。

就这样运行：
`sudo -u *user*jstackSeries.sh *pid* *aemserveruser* *count* *delay*`

例如：`sudo -u aemuser jstackSeries.sh 1234 aemserveruser 10 3`

- <b>1234</b> 是 [!DNL Java] 过程
- <b>cq5serveruser</b> 是 [!DNL Linux] 或 [!DNL Java] 进程作为
- <b>10</b> 是有多少线程转储
- <b>3</b> 是每个转储之间的延迟


<b>注意： </b>顶部输出的本机线程id采用十进制格式，而jstack输出的nid采用十六进制格式。  通过将线程ID转换为十六进制，可以将高cpu线程从顶部输出与jstack输出进行匹配。

除了上述脚本之外，我们还具有类似的 [[!DNL Windows] Github上的Powershell脚本和AdobeAEM特定脚本](https://github.com/cqsupport/jstackSeries.sh).

<b>适用于Adobe Experience Manager的线程转储工具</b>

如果您使用的是Adobe Experience Manager产品，则可以安装 [此工具](https://helpx.adobe.com/experience-manager/kb/thread-dumps-collection-analysis.html) 以提供用于生成线程转储的简单UI。
<br><br>获取线程转储的替代方法<br><br>
如果 <b>jstack</b> 工具不可用，则可以按如下方式获取线程转储：

<b>注意：</b> 如果命令行参数为，某些工具无法从JVM获取线程转储 `-Xrs` 启用。 如果您在转储线程时遇到问题，请查看此选项是否已启用。
<br><br>UNIX、Mac OS X和 [!DNL Linux] （JDK 1.4或更高版本）<br><br>
在UNIX、Mac OS X和 [!DNL Linux]，则可以向 [!DNL Java] 进程，让其将线程转储输出到标准输出。

1. 运行此命令可执行以下操作：

   `kill -QUIT *pid*`

   您可能需要将此命令作为 `sudo -u user kill -QUIT *pid*` 其中，“user”是 [!DNL Java] 进程以形式运行。
2. 如果您使用 `crx-quickstart/server/start` 脚本，则线程转储将输出到 `crx-quickstart/server/logs/startup.log`. 如果您使用的是第三方应用程序服务器，例如JBoss， [!DNL WebSphere], [!DNL Tomcat]或者，参阅服务器文档，以了解标准输出指向的文件。

[!DNL Windows]:<br><br>JDK 1.X
1. 下载javadump.exe（下面附加）。
2. 使用以下三个参数（它们必须按正确的顺序）启动JVM:

   `-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput -XX:LogFile=*C:\temp\jvmoutput.log*`
3. 按Ctrl+Shift+Esc打开任务管理器。
4. 查找 [!DNL Java] 进程。
5. 从命令行中，运行

   `javadump.exe *pid*`
6. 线程转储将显示在 `jvmoutput.log` 文件。

<br><br>JDK 1.6<br><br>
从获取线程转储 <b>jconsole</b> 工具，使用插件：0

以下是请求线程转储的方式：

1. 将以下参数添加到运行的jvm中 `Communique` : `-Dcom.sun.management.jmxremote`
2. 下载并安装JDK 1.6（如果尚未完成）。
3. 下载并提取 [线程转储分析器实用程序](https://github.com/irockel/tda). 1
4. 运行 `jconsole.exe` 在JDK 1.6中：

                               `jconsole.exe -pluginpath /path/to/file/tda.jar`
5. 单击 <b>线程转储</b> 选项卡。
6. 单击 <b>请求线程转储</b> 链接。

<b>注意：</b> 如果您运行的是AEM 6。\*如果想要观察正在运行的线程，则可以请求 `http://host:port/system/console/status-Threads` 以获取线程列表。 但是，请注意，这些线程转储无法用于线程转储分析工具，如武士或tda。<br><br>适用于<br><br>
在JVM中运行的所有Adobe产品
<br><br>线程转储分析工具：<br><br>
0 [http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)
1  [https://github.com/irockel/tda](https://github.com/irockel/tda)
2 [https://fastthread.io/](https://fastthread.io/)
3 [https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm](https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm)
